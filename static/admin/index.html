<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>内容管理</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- 添加 Prism.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
  
  <!-- 自定义样式 -->
  <style>
    /* 确保代码块样式清晰可见 */
    pre[class*="language-"] {
      background: #2d2d2d;
      color: #ccc;
      padding: 1em;
      margin: 1em 0;
      border-radius: 5px;
      overflow: auto;
    }

    code[class*="language-"] {
      font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
      text-align: left;
      white-space: pre;
      word-spacing: normal;
      word-break: normal;
      word-wrap: normal;
      line-height: 1.5;
      tab-size: 4;
    }
  </style>
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Prism.js 和语言支持 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  
  <script>
    // 简单的代码块预览组件
    const PostPreview = createClass({
      render: function() {
        const entry = this.props.entry;
        const title = entry.getIn(['data', 'title']) || '';
        
        return h('div', { className: 'content' },
          h('h1', {}, title),
          h('div', {}, this.props.widgetFor('body'))
        );
      }
    });
    
    // 注册预览模板
    CMS.registerPreviewTemplate('posts', PostPreview);
    CMS.registerPreviewTemplate('pages', PostPreview);
    
    // 注册代码块编辑器组件
    CMS.registerEditorComponent({
      id: "code",
      label: "代码块",
      fields: [
        {
          name: "language",
          label: "语言",
          widget: "select",
          options: ["javascript", "css", "html", "python", "bash", "yaml", "json"],
          default: "javascript"
        },
        {
          name: "code",
          label: "代码",
          widget: "text"
        }
      ],
      pattern: /^```(\w+)\n([\s\S]*?)```$/,
      fromBlock: function(match) {
        return {
          language: match[1],
          code: match[2]
        };
      },
      toBlock: function(data) {
        return "```" + data.language + "\n" + data.code + "\n```";
      },
      toPreview: function(data) {
        // 确保 HTML 特殊字符被正确编码
        const encodedCode = data.code
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
          
        return (
          '<pre class="language-' + data.language + '">' +
            '<code class="language-' + data.language + '">' +
              encodedCode +
            '</code>' +
          '</pre>'
        );
      }
    });
  </script>

  <!-- 用于在预览中启用代码高亮的脚本 -->
  <script>
    // 等待 CMS 加载完毕
    document.addEventListener('DOMContentLoaded', function() {
      // 确保 Prism.js 已加载
      if (typeof Prism !== 'undefined') {
        console.log('Prism.js 已加载');
        
        // 尝试向预览 iframe 中注入 Prism.js
        setInterval(function() {
          try {
            // 查找所有 iframe
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(function(iframe) {
              try {
                // 尝试访问 iframe 内容
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // 如果成功访问，检查是否已注入脚本
                if (iframeDoc && !iframeDoc.getElementById('prism-injected')) {
                  // 创建样式元素
                  const style = iframeDoc.createElement('link');
                  style.id = 'prism-injected';
                  style.rel = 'stylesheet';
                  style.href = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css';
                  iframeDoc.head.appendChild(style);
                  
                  // 创建脚本元素
                  const script = iframeDoc.createElement('script');
                  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js';
                  script.onload = function() {
                    // 加载语言支持
                    const languages = ['javascript', 'css', 'python', 'bash', 'yaml'];
                    languages.forEach(function(lang) {
                      const langScript = iframeDoc.createElement('script');
                      langScript.src = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-${lang}.min.js`;
                      iframeDoc.body.appendChild(langScript);
                    });
                    
                    // 手动触发高亮
                    setTimeout(function() {
                      if (typeof iframeDoc.defaultView.Prism !== 'undefined') {
                        iframeDoc.defaultView.Prism.highlightAll();
                      }
                    }, 1000);
                  };
                  iframeDoc.body.appendChild(script);
                  
                  console.log('已向 iframe 注入 Prism.js');
                } else if (iframeDoc && typeof iframeDoc.defaultView.Prism !== 'undefined') {
                  // 如果已注入 Prism，尝试高亮代码
                  iframeDoc.defaultView.Prism.highlightAll();
                }
              } catch (e) {
                // 跨域问题或其他错误，忽略这个 iframe
              }
            });
          } catch (e) {
            console.error('注入 Prism.js 时出错:', e);
          }
        }, 3000);
      }
    });
  </script>
</body>
</html>