<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>内容管理</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // 自定义预览模板
    const PostPreview = createClass({
      render: function() {
        const entry = this.props.entry;
        const title = entry.getIn(['data', 'title']) || '';
        
        return h('div', { className: 'content' },
          h('h1', {}, title),
          h('div', {
            dangerouslySetInnerHTML: {
              __html: `
                <div id="preview-content">
                  ${this.props.widgetFor('body')}
                </div>
                
                <!-- 内联 Prism.js CSS -->
                <style>
                  /* Prism Tomorrow Night Theme */
                  code[class*="language-"], pre[class*="language-"] {
                    color: #ccc;
                    background: none;
                    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
                    font-size: 1em;
                    text-align: left;
                    white-space: pre;
                    word-spacing: normal;
                    word-break: normal;
                    word-wrap: normal;
                    line-height: 1.5;
                    tab-size: 4;
                    hyphens: none;
                  }
                  
                  pre[class*="language-"] {
                    padding: 1em;
                    margin: .5em 0;
                    overflow: auto;
                    border-radius: 0.3em;
                    background: #2d2d2d;
                  }
                  
                  :not(pre) > code[class*="language-"] {
                    padding: .1em;
                    border-radius: .3em;
                    white-space: normal;
                    background: #2d2d2d;
                  }
                  
                  .token.comment, .token.block-comment, .token.prolog, .token.doctype, .token.cdata {
                    color: #999;
                  }
                  
                  .token.punctuation {
                    color: #ccc;
                  }
                  
                  .token.tag, .token.attr-name, .token.namespace, .token.deleted {
                    color: #e2777a;
                  }
                  
                  .token.function-name {
                    color: #6196cc;
                  }
                  
                  .token.boolean, .token.number, .token.function {
                    color: #f08d49;
                  }
                  
                  .token.property, .token.class-name, .token.constant, .token.symbol {
                    color: #f8c555;
                  }
                  
                  .token.selector, .token.important, .token.atrule, .token.keyword, .token.builtin {
                    color: #cc99cd;
                  }
                  
                  .token.string, .token.char, .token.attr-value, .token.regex, .token.variable {
                    color: #7ec699;
                  }
                  
                  .token.operator, .token.entity, .token.url {
                    color: #67cdcc;
                  }
                  
                  .token.important, .token.bold {
                    font-weight: bold;
                  }
                  
                  .token.italic {
                    font-style: italic;
                  }
                  
                  .token.entity {
                    cursor: help;
                  }
                  
                  .token.inserted {
                    color: green;
                  }
                </style>
                
                <!-- 内联 Prism.js -->
                <script>
                /* Prism.js 核心代码 (简化版) */
                (function(){
                  var self = window.Prism = {
                    languages: {}
                  };
                  
                  var lang = /\\b(?:javascript|python|css|html|bash|go|java|yaml|json|markdown)\\b/i;
                  
                  // 核心高亮函数
                  self.highlight = function(text, grammar, language) {
                    return text
                      .replace(/\\/\\*[\\s\\S]*?\\*\\//g, match => '<span class="token comment">' + match + '</span>')
                      .replace(/\\/\\/.+/g, match => '<span class="token comment">' + match + '</span>')
                      .replace(/"(?:\\\\.|[^"\\\\])*"/g, match => '<span class="token string">' + match + '</span>')
                      .replace(/'(?:\\\\.|[^'\\\\])*'/g, match => '<span class="token string">' + match + '</span>')
                      .replace(/\\b(?:function|return|if|else|for|while|class|var|let|const)\\b/g, match => '<span class="token keyword">' + match + '</span>')
                      .replace(/\\b(?:true|false|null|undefined)\\b/g, match => '<span class="token boolean">' + match + '</span>')
                      .replace(/\\b\\d+(?:\\.\\d+)?\\b/g, match => '<span class="token number">' + match + '</span>')
                      .replace(/[()[\\]{}]/g, match => '<span class="token punctuation">' + match + '</span>');
                  };
                  
                  // 尝试获取语言
                  function getLanguage(element) {
                    var classes = element.className.split(/\\s+/);
                    for (var i = 0; i < classes.length; i++) {
                      if (lang.test(classes[i])) {
                        return classes[i].replace('language-', '');
                      }
                    }
                    return 'javascript'; // 默认
                  }
                  
                  // 高亮页面上的所有代码块
                  function highlightAll() {
                    console.log('尝试高亮所有代码块...');
                    var pres = document.querySelectorAll('pre');
                    console.log('找到 ' + pres.length + ' 个 pre 元素');
                    
                    pres.forEach(function(pre) {
                      // 查找或创建 code 元素
                      var code = pre.querySelector('code') || pre;
                      var language = getLanguage(code) || getLanguage(pre);
                      
                      // 确保代码块有语言类
                      if (!pre.className.includes('language-')) {
                        pre.className = 'language-' + language + ' ' + pre.className;
                      }
                      if (code !== pre && !code.className.includes('language-')) {
                        code.className = 'language-' + language + ' ' + code.className;
                      }
                      
                      // 高亮代码
                      if (code.textContent.trim()) {
                        var originalContent = code.textContent;
                        try {
                          code.innerHTML = self.highlight(originalContent, null, language);
                          console.log('已高亮代码块:', language);
                        } catch(e) {
                          console.error('高亮代码时出错:', e);
                          code.textContent = originalContent; // 还原原始内容
                        }
                      }
                    });
                    
                    // 高亮行内代码
                    var inlineCodes = document.querySelectorAll('code:not(pre code)');
                    console.log('找到 ' + inlineCodes.length + ' 个行内代码元素');
                    
                    inlineCodes.forEach(function(code) {
                      var language = getLanguage(code) || 'text';
                      if (!code.className.includes('language-')) {
                        code.className = 'language-' + language + ' ' + code.className;
                      }
                      
                      if (code.textContent.trim()) {
                        var originalContent = code.textContent;
                        try {
                          code.innerHTML = self.highlight(originalContent, null, language);
                        } catch(e) {
                          code.textContent = originalContent; // 还原原始内容
                        }
                      }
                    });
                  }
                  
                  // 等待一段时间后高亮
                  setTimeout(highlightAll, 300);
                  
                  // 定期检查新的代码块
                  setInterval(highlightAll, 3000);
                  
                  // 导出全局函数以便手动调用
                  window.highlightAllCode = highlightAll;
                })();
                </script>
              `
            }
          })
        );
      }
    });
    
    // 注册预览模板
    CMS.registerPreviewTemplate('posts', PostPreview);
    CMS.registerPreviewTemplate('pages', PostPreview);
    
    // 注册代码块编辑器组件
    CMS.registerEditorComponent({
      id: "code",
      label: "代码块",
      fields: [
        {
          name: "language",
          label: "语言",
          widget: "select",
          options: ["javascript", "css", "html", "python", "bash", "go", "java", "yaml", "json", "markdown"],
          default: "javascript"
        },
        {
          name: "code",
          label: "代码",
          widget: "text"
        }
      ],
      pattern: /^```(\w+)\n([\s\S]*?)```$/,
      fromBlock: function(match) {
        return {
          language: match[1],
          code: match[2]
        };
      },
      toBlock: function(data) {
        return "```" + data.language + "\n" + data.code + "\n```";
      },
      toPreview: function(data) {
        // 确保 HTML 特殊字符被正确编码
        const encodedCode = data.code
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
          
        return (
          '<pre class="language-' + data.language + '">' +
            '<code class="language-' + data.language + '">' +
              encodedCode +
            '</code>' +
          '</pre>'
        );
      }
    });
    
    // 在代码编辑器中添加```作为快捷方式
    CMS.registerShortcode({
      id: "code-shortcut",
      pattern: /^```(\w+)/m,
      process: function(match, index) {
        // 如果找到```开头的代码块，添加结束标记
        return {
          output: match + "\n\n```",
          newIndex: index + match.length + 2
        };
      }
    });
  </script>
</body>
</html>