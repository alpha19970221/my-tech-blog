<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>内容管理</title>
  <!-- CMS必要的脚本先加载 -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- 代码高亮样式 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
  <!-- 初始样式 -->
  <style>
    .format-button {
      padding: 5px 10px;
      background: #4a8fee;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 0;
    }
    
    .format-button:hover {
      background: #3a7edf;
    }
  </style>
</head>
<body>
  <!-- 确保CMS是第一个加载的脚本 -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- 在CMS加载后延迟添加其他脚本 -->
  <script>
    // 等待CMS加载完成
    function whenCmsReady(callback) {
      if (window.CMS) {
        callback();
      } else {
        setTimeout(() => whenCmsReady(callback), 100);
      }
    }
    
    // 在CMS加载完成后加载其他脚本
    whenCmsReady(() => {
      // 加载必要的脚本
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js', function() {
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js');
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js');
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js');
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js');
      });
      
      // 加载Prettier
      loadScript('https://unpkg.com/prettier@2.8.8/standalone.js', function() {
        loadScript('https://unpkg.com/prettier@2.8.8/parser-babel.js');
        loadScript('https://unpkg.com/prettier@2.8.8/parser-html.js');
        loadScript('https://unpkg.com/prettier@2.8.8/parser-postcss.js');
        loadScript('https://unpkg.com/prettier@2.8.8/parser-markdown.js');
        loadScript('https://unpkg.com/prettier@2.8.8/parser-yaml.js');
        
        // 脚本都加载完后，初始化格式化功能
        initFormatter();
      });
    });
    
    // 函数：加载脚本
    function loadScript(src, callback) {
      const script = document.createElement('script');
      script.src = src;
      if (callback) {
        script.onload = callback;
      }
      document.body.appendChild(script);
    }
    
    // 初始化格式化功能
    function initFormatter() {
      // 代码格式化函数
      function formatCode(code, language) {
        try {
          // 确定Prettier解析器
          let parser;
          switch (language.toLowerCase()) {
            case 'javascript':
            case 'js':
              parser = 'babel';
              break;
            case 'typescript':
            case 'ts':
              parser = 'typescript';
              break;
            case 'css':
              parser = 'css';
              break;
            case 'html':
              parser = 'html';
              break;
            case 'yaml':
            case 'yml':
              parser = 'yaml';
              break;
            case 'json':
              parser = 'json';
              break;
            case 'markdown':
            case 'md':
              parser = 'markdown';
              break;
            default:
              // 对于不支持的语言，保持原样
              return code;
          }
          
          // 格式化代码
          const formatted = prettier.format(code, {
            parser,
            printWidth: 80,
            tabWidth: 2,
            useTabs: false,
            semi: true,
            singleQuote: true,
            trailingComma: 'es5',
            bracketSpacing: true,
          });
          
          return formatted;
        } catch (e) {
          console.error('格式化失败:', e);
          return code; // 如果格式化失败，返回原始代码
        }
      }
      
      // 格式化Markdown中的代码块
      function formatMarkdownCodeBlocks(markdownText) {
        if (!markdownText) return markdownText;
        
        // 匹配代码块的正则表达式：```language\n code \n```
        const codeBlockRegex = /```(\w+)?\n([\s\S]*?)\n```/g;
        
        return markdownText.replace(codeBlockRegex, (match, language, code) => {
          // 如果没有指定语言，默认为javascript
          const lang = language || 'javascript';
          
          try {
            // 格式化代码
            const formattedCode = formatCode(code, lang);
            return '```' + lang + '\n' + formattedCode + '\n```';
          } catch (e) {
            console.error('代码块格式化失败:', e);
            return match; // 保持原样
          }
        });
      }
      
      // 添加格式化按钮和快捷键
      function setupFormatting() {
        // 查找所有可能的Markdown编辑器
        const allTextareas = document.querySelectorAll('textarea');
        
        allTextareas.forEach(textarea => {
          // 避免重复添加
          if (textarea.dataset.formatterSetup) return;
          
          textarea.dataset.formatterSetup = 'true';
          
          // 添加快捷键支持
          textarea.addEventListener('keydown', function(e) {
            // Ctrl+Shift+F 或 Cmd+Shift+F
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
              e.preventDefault();
              const value = textarea.value;
              textarea.value = formatMarkdownCodeBlocks(value);
              // 触发change事件
              textarea.dispatchEvent(new Event('input', { bubbles: true }));
            }
          });
          
          // 添加格式化按钮
          const parent = textarea.parentElement;
          if (parent && !parent.querySelector('.format-button')) {
            const button = document.createElement('button');
            button.className = 'format-button';
            button.textContent = '格式化代码块 (Ctrl+Shift+F)';
            button.onclick = function(e) {
              e.preventDefault();
              textarea.value = formatMarkdownCodeBlocks(textarea.value);
              // 触发change事件
              textarea.dispatchEvent(new Event('input', { bubbles: true }));
            };
            
            parent.insertBefore(button, textarea);
          }
        });
      }
      
      // 持续监控DOM变化，为新添加的编辑器添加格式化功能
      const observer = new MutationObserver((mutations) => {
        setupFormatting();
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // 立即为现有编辑器添加格式化功能
      setupFormatting();
      
      // 每隔2秒检查一次，确保按钮正确添加
      setInterval(setupFormatting, 2000);
      
      // 控制台提示已加载
      console.log('代码格式化功能已加载 - 使用Ctrl+Shift+F格式化代码块');
    }
  </script>
</body>
</html>